隆Te ayudo a encontrar la Ubicaci贸n 5!
Busca estas l铆neas al final de la funci贸n setupWebSocket (deber铆an estar alrededor de l铆nea 400-410):
typescript  // Configurar funci贸n global con la funci贸n robusta
  (global as any).getUserSocket = getUserSocketRobust;

  console.log(` [WS] Funci贸n getUserSocket configurada con manejo robusto`);

  return {
    io,
    emitPrintJob,
    emitPrintJobToUser,
    getConnectedClients: () => connectedClients.size,
    getUserSocket: getUserSocketRobust
  };
}
AGREGAR este c贸digo JUSTO ANTES del return {:Modificaci贸n 5 - Antes del return en setupWebSocketC贸digo  // Broadcast inicial de estad铆sticas cuando se inicializa
  setTimeout(() => {
    broadcastUserStats();
  }, 1000);

  // Monitoreo peri贸dico y limpieza de usuarios inactivos cada 60 segundos
  setInterval(() => {
    const now = new Date();
    lLocaliz贸 y explic贸 d贸nde agregar c贸digo espec铆fico0sHe creado el c贸digo que necesita agregar antes del return. Ahora voy a explicarle exactamente d贸nde colocarlo.Aqu铆 est谩 el antes y despu茅s:
ANTES (lo que tienes ahora):
typescript  // Configurar funci贸n global con la funci贸n robusta
  (global as any).getUserSocket = getUserSocketRobust;

  console.log(` [WS] Funci贸n getUserSocket configurada con manejo robusto`);

  return {
    io,
    emitPrintJob,
    emitPrintJobToUser,
    getConnectedClients: () => connectedClients.size,
    getUserSocket: getUserSocketRobust
  };
}
DESPUS (como debe quedar):
typescript  // Configurar funci贸n global con la funci贸n robusta
  (global as any).getUserSocket = getUserSocketRobust;

  // NUEVO: Broadcast inicial de estad铆sticas cuando se inicializa
  setTimeout(() => {
    broadcastUserStats();
  }, 1000);

  // NUEVO: Monitoreo peri贸dico y limpieza de usuarios inactivos cada 60 segundos
  setInterval(() => {
    const now = new Date();
    let removedUsers = 0;
    
    // Limpiar usuarios inactivos (m谩s de 2 minutos sin actividad)
    activeUsers.forEach((userInfo, userId) => {
      const inactiveTime = now.getTime() - userInfo.lastActivity.getTime();
      if (inactiveTime > 120000) { // 2 minutos
        console.log(`Ч [WS] Removiendo usuario inactivo: ${userInfo.username}`);
        activeUsers.delete(userId);
        removedUsers++;
      }
    });
    
    if (removedUsers > 0) {
      broadcastUserStats();
    }
    
    // Log estad铆sticas cada 60 segundos
    console.log(` [WS] Usuarios activos: ${activeUsers.size}`);
    if (activeUsers.size > 0) {
      console.log(` [WS] Lista de usuarios:`);
      activeUsers.forEach((userInfo) => {
        const duration = Math.floor((now.getTime() - userInfo.joinTime.getTime()) / 1000);
        console.log(`   - ${userInfo.username} (${duration}s conectado)`);
      });
    }
  }, 60000);

  console.log(` [WS] Funci贸n getUserSocket configurada con manejo robusto`);

  return {
    io,
    emitPrintJob,
    emitPrintJobToUser,
    getConnectedClients: () => connectedClients.size,
    getUserSocket: getUserSocketRobust
  };
}
 Resumen:
Insertar todo el c贸digo del artifact entre la l铆nea:

(global as any).getUserSocket = getUserSocketRobust;

Y antes de la l铆nea:

console.log(\ [WS] Funci贸n getUserSocket configurada con manejo robusto`);`

驴Ya encontraste esa ubicaci贸n? Una vez que agregues esto, ya tendr谩s casi completo el websocket.ts. Solo faltar铆a la modificaci贸n 6 (los exports al final del archivo). 